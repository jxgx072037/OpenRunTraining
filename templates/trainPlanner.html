{% extends "base.html" %}

{% block title %}比赛路线{% endblock %}

{% block extra_css %}
    <style>
    .upload-container {
        text-align: left;
        padding: 30px;
        margin-bottom: 20px;
        background-color: #f8f9fa;
        border-radius: 8px;
        border: 2px dashed #ddd;
    }
    
    .upload-form {
        max-width: 600px;
            margin: 0;
    }
    
    .form-group {
        margin-bottom: 20px;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 6px;
        color: #666;
        font-weight: 500;
    }
    
    .required::after {
        content: "*";
        color: #FC4C02;
        margin-left: 4px;
    }
    
    .file-size-hint {
        margin-top: 8px;
        font-size: 13px;
        color: #888;
        font-style: italic;
    }
    
    .form-group input[type="text"] {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .form-group input[type="date"] {
        padding: 7px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
    }
    
    .file-input-group {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .file-name {
        color: #666;
        font-size: 14px;
        margin-left: 10px;
    }
    
    #file-input {
        display: none;
    }
    
    .custom-file-upload {
        display: inline-flex;
        align-items: center;
        padding: 8px 20px;
        background-color: #FC4C02;
        color: white;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
        font-size: 14px;
    }
    
    .custom-file-upload i {
        margin-right: 8px;
    }
    
    .submit-btn {
        display: inline-flex;
        align-items: center;
        padding: 10px 25px;
            background-color: #FC4C02;
            color: white;
        border: none;
            border-radius: 4px;
        cursor: pointer;
            transition: background-color 0.3s;
        font-size: 15px;
        font-weight: 500;
        }
    
    .submit-btn:hover, .custom-file-upload:hover {
            background-color: #E34402;
        }
    
    .submit-btn:disabled, .custom-file-upload.disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
    
    .submit-btn i {
        margin-right: 8px;
    }
    
    .upload-title {
        margin-bottom: 15px;
        color: #666;
        font-size: 20px;
        text-align: left;
    }
    
    .upload-description {
        color: #888;
        margin-bottom: 20px;
        font-size: 14px;
        text-align: left;
    }
    
    #data-container {
        display: none;
    }
    
    /* 从gpx_viewer.html复制的样式 */
    .map-container {
        height: 600px;
        margin-bottom: 20px;
        border-radius: 8px;
        overflow: hidden;
        display: none;
        position: relative;
    }
    
    .elevation-chart {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 200px;
        background: rgba(255, 255, 255, 0.7);
        z-index: 1000;
        padding: 10px;
    }
    
    .stats-container {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .stat-card {
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        text-align: center;
    }
    
    .stat-value {
        font-size: 24px;
        font-weight: bold;
        color: #FC4C02;
        margin: 10px 0;
    }
    
    .stat-label {
        color: #666;
        font-size: 14px;
    }
    
    .loading {
        display: none;
        text-align: center;
        padding: 20px;
        font-size: 18px;
        color: #666;
    }
    
    .loading i {
        margin-right: 10px;
        color: #FC4C02;
    }
    
    .hover-marker {
        transition: opacity 0.3s ease;
    }
    
    .formula-note {
        color: #666;
        font-size: 12px;
        margin-top: 8px;
        font-style: italic;
        line-height: 1.3;
    }
    
    .segment-table-container {
        margin-top: 30px;
        margin-bottom: 30px;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    }
    
    .segment-table-container h3 {
            margin-bottom: 20px;
        color: #333;
    }
    
    .table {
        width: 100%;
        margin-bottom: 0;
    }
    
    .table th {
        background-color: #f8f9fa;
        border-top: none;
        color: #666;
        font-weight: 600;
    }
    
    .table td, .table th {
        padding: 12px;
        text-align: center;
        vertical-align: middle;
    }
    
    .table tbody tr:hover {
        background-color: #f8f9fa;
        }
    
    .map-weather-container {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
    }
    
    .map-container {
        flex: 2;
        margin-bottom: 0;
    }
    
    .training-advice-container {
        margin-bottom: 20px;
    }
    
    .training-advice-title {
        margin-bottom: 10px;
    }
    
    .training-advice-content {
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-word;
        overflow: auto;
        max-height: 500px;
        border: 1px solid #ddd;
        padding: 10px;
        width: 100%;
        box-sizing: border-box;
    }
    
    /* 针对小屏幕设备的训练建议样式 */
    @media (max-width: 768px) {
        .training-advice-content {
            font-size: 14px;
            padding: 8px;
            max-height: 400px;
        }
    }
    
    /* 训练建议中Markdown表格的样式 */
    .training-advice-content table {
        width: 100%;
        border-collapse: collapse;
        margin: 15px 0;
        overflow-x: auto;
        display: block;
    }
    
    .training-advice-content th,
    .training-advice-content td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }
    
    .training-advice-content th {
        background-color: #f2f2f2;
    }
    
    /* 针对小屏幕设备的表格样式 */
    @media (max-width: 768px) {
        .training-advice-content th,
        .training-advice-content td {
            padding: 5px;
            font-size: 12px;
        }
    }
    
    .loading-advice {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
        color: #666;
        font-size: 16px;
        margin-bottom: 15px;
    }
    
    .loading-advice i {
        margin-right: 10px;
        color: #FC4C02;
    }
    
    .weather-container {
        flex: 1;
        background: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        display: none;
        height: 600px;  /* 设置与地图相同的高度 */
        overflow: hidden;  /* 更改为hidden，禁用滚动条 */
    }
    
    .weather-title {
        font-size: 16px;
        color: #666;
        margin-bottom: 10px;  /* 减少标题底部间距 */
        font-weight: 500;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .weather-data {
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        height: calc(100% - 60px);
    }
    
    /* 添加更高优先级的选择器覆盖 Chart.js 的默认样式 */
    .weather-data canvas.weather-chart {
        height: 150px !important;
        max-height: 150px !important;
        margin-bottom: 15px;
    }
    
    /* 确保表格容器获得足够的空间 */
    .weather-table-container {
        flex: 1;
        overflow: hidden;
        min-height: 400px; /* 确保表格有固定的最小高度 */
    }
    
    .weather-table {
        width: 100%;
        font-size: 12px;  /* 减小字体大小 */
        margin-top: 15px; /* 确保表格与图表有足够间距 */
    }
    
    .weather-table th {
        text-align: left;
        color: #666;
        font-weight: 500;
        padding: 4px 4px;  /* 减少表格单元格内边距 */
        border-bottom: 1px solid #eee;
    }
    
    .weather-table td {
        padding: 4px 4px;  /* 减少表格单元格内边距 */
        border-bottom: 1px solid #eee;
    }
    
    .weather-source {
        font-size: 11px;  /* 减小字体大小 */
        color: #888;
        display: inline-block;
    }
    
    .weather-source a {
        color: #FC4C02;
        text-decoration: none;
    }
    
    .weather-source a:hover {
        text-decoration: underline;
    }
    
    .loading-weather {
        display: none;
        text-align: center;
        padding: 20px;
        font-size: 18px;
        color: #666;
    }
    
    .loading-weather i {
        margin-right: 10px;
        color: #FC4C02;
        }
    
    /* AI思考过程区域样式 */
    .ai-thinking-section {
        margin: 10px 0;
        border-radius: 5px;
        overflow: hidden;
    }
    
    .ai-thinking-section summary {
        background-color: #f0f8ff;
        padding: 8px 12px;
        cursor: pointer;
        font-weight: bold;
        border: 1px solid #cce5ff;
        border-radius: 4px;
    }
    
    .ai-thinking-section summary:hover {
        background-color: #e6f4ff;
    }
    
    .ai-thinking-section .thinking-content {
        background-color: #f8f8f8;
        border: 1px solid #ddd;
        border-top: none;
        padding: 10px;
        color: #555;
        font-size: 14px;
        max-height: 300px;
        overflow: auto;
        white-space: pre-wrap;
        word-break: break-word;
    }
    
    /* 自定义提示词样式 */
    .customize-prompt-container {
        margin-bottom: 20px;
    }
    
    .customize-prompt-container textarea {
        font-family: monospace;
        font-size: 14px;
        line-height: 1.5;
        resize: vertical;
    }
    
    .customize-prompt-container .card-header {
        background-color: #f8f9fa;
    }
    
    .customize-prompt-container .form-text {
        color: #6c757d;
        font-size: 12px;
        margin-top: 4px;
    }
    
    #generate-advice-btn {
        padding: 12px;
        font-weight: 600;
        font-size: 16px;
        transition: all 0.3s;
    }
    
    #generate-advice-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(252, 76, 2, 0.3);
    }
    
    /* 项目灵感来源样式 */
    .inspiration-credit {
        text-align: right;
        margin: 10px 0;
        padding: 8px 15px;
        font-size: 14px;
        color: #333;
        font-style: italic;
        position: absolute;
        bottom: 30px;
        right: 10px;
        background-color: rgba(255, 255, 255, 0.9);
        border-radius: 4px;
        display: inline-block;
        z-index: 1000;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        border: 1px solid #ddd;
    }
    
    .inspiration-credit a {
        color: #FC4C02;
        text-decoration: none;
        font-weight: 500;
    }
    
    .inspiration-credit a:hover {
        text-decoration: underline;
    }
    
    @media (max-width: 768px) {
        .inspiration-credit {
            font-size: 12px;
            padding: 5px 10px;
            bottom: 20px;
        }
    }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
    <div class="upload-container">
        <h2 class="upload-title">上传比赛路线</h2>
        <p class="upload-description">上传GPX格式的比赛路线文件，并填写相关信息，开始规划您的训练计划。</p>
        <form id="upload-form" class="upload-form" enctype="multipart/form-data">
            <div class="form-group">
                <label for="race-name">比赛名称</label>
                <input type="text" id="race-name" name="race_name" placeholder="例如：2026香港100">
            </div>
            
            <div class="form-group">
                <label for="file-input" class="required">比赛轨迹</label>
                <div class="file-input-group">
                    <label for="file-input" class="custom-file-upload" id="upload-label">
                        <i class="fas fa-upload"></i> 选择GPX文件
                    </label>
                    <input type="file" id="file-input" name="gpx_file" accept=".gpx">
                    <span class="file-name" id="file-name"></span>
                </div>
                <p class="file-size-hint">GPX文件大小限制：20MB以内</p>
            </div>
            
            <div class="form-group">
                <label for="race-date" class="required">比赛日期</label>
                <input type="date" id="race-date" name="race_date" required>
            </div>
            
            <button type="submit" class="submit-btn" id="submit-btn" disabled>
                <i class="fas fa-check"></i> 确认上传
            </button>
        </form>
    </div>
    
    <div class="loading" id="loading">
        <i class="fas fa-spinner fa-spin"></i> <span id="loading-text">正在解析GPX文件...</span>
    </div>
    
    <div id="data-container">
        <div class="map-weather-container">
            <div id="map" class="map-container">
                <div class="elevation-chart">
                    <canvas id="elevation-chart"></canvas>
                </div>
                <div class="inspiration-credit">
                    项目灵感来自于：<a href="https://activities.geekplux.com/" target="_blank">Geekplus</a> 和 <a href="https://runart.net/firefly/" target="_blank">RunArt Firefly</a>
                </div>
            </div>
            
            <div class="weather-container" id="weather-container">
                <h3 class="weather-title">
                    历史天气数据
                    <span class="weather-source">数据来源: <a href="https://www.visualcrossing.com/" target="_blank">Visual Crossing Weather</a></span>
                </h3>
                <div class="weather-data">
                    <canvas id="temperatureChart" class="weather-chart"></canvas>
                    <div class="weather-table-container">
                        <table class="weather-table">
                            <thead>
                                <tr>
                                    <th>年份</th>
                                    <th>温度</th>
                                    <th>湿度</th>
                                    <th>降水</th>
                                    <th>风速</th>
                                </tr>
                            </thead>
                            <tbody id="weather-table-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="training-advice-container" id="training-advice-container" style="display: none;">
            <h3 class="training-advice-title">
                AI训练建议
            </h3>
            <div class="customize-prompt-container">
                <div class="card mb-4">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">自定义提示词</h5>
                        <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#promptCollapse">
                            <i class="fas fa-cog"></i> 显示/隐藏
                        </button>
                    </div>
                    <div class="collapse" id="promptCollapse">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="system-prompt" class="form-label">系统提示词 (System Prompt)</label>
                                        <textarea class="form-control" id="system-prompt" rows="12" placeholder="输入自定义系统提示词，或使用默认设置"></textarea>
                                        <div class="form-text">系统提示词定义AI的角色和行为准则，如不确定请使用默认配置</div>
                                        <button class="btn btn-sm btn-outline-secondary mt-2" id="reset-system-prompt">恢复默认</button>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label for="user-prompt" class="form-label">用户提示词 (Prompt)</label>
                                        <textarea class="form-control" id="user-prompt" rows="12" placeholder="输入自定义用户提示词，或使用默认设置"></textarea>
                                        <div class="form-text">用户提示词描述具体任务要求，如不确定请使用默认配置</div>
                                        <button class="btn btn-sm btn-outline-secondary mt-2" id="reset-user-prompt">恢复默认</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="d-grid gap-2 mb-4">
                    <button class="btn btn-strava btn-lg" id="generate-advice-btn">
                        <i class="fas fa-robot me-2"></i> 生成AI训练建议
                    </button>
                </div>
            </div>
            <div id="loading-advice" class="loading-advice" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i> 正在生成训练建议...
            </div>
            <div class="training-advice-content" id="training-advice-content"></div>
        </div>
        
        <div class="stats-container">
            <div class="stat-card">
                <div class="stat-value" id="total-distance">-</div>
                <div class="stat-label">总距离（公里）</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-elevation-gain">-</div>
                <div class="stat-label">总爬升（米）</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="average-grade">-</div>
                <div class="stat-label">平均爬升坡度</div>
                <div class="formula-note">坡度（%）=（垂直爬升高度 / 水平距离）× 100%</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-elevation-loss">-</div>
                <div class="stat-label">总下降（米）</div>
            </div>
        </div>
        
        <div class="segment-table-container">
            <h3>分段数据</h3>
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>段号</th>
                            <th>累计距离(km)</th>
                            <th>爬升(m)</th>
                            <th>平均爬升坡度(%)</th>
                            <th>下降(m)</th>
                        </tr>
                    </thead>
                    <tbody id="segment-table-body">
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- 引入第三方JS库 -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.0"></script>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/leaflet-gpx@1.7.0/gpx.min.js"></script>
<!-- 脚本区 -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // 初始化页面元素引用
    const elements = {
        form: document.getElementById('upload-form'),
        fileInput: document.getElementById('file-input'),
        fileName: document.getElementById('file-name'),
        raceName: document.getElementById('race-name'),
        raceDate: document.getElementById('race-date'),
        submitBtn: document.getElementById('submit-btn'),
        uploadLabel: document.getElementById('upload-label'),
        loadingDiv: document.getElementById('loading'),
        dataContainer: document.getElementById('data-container'),
        mapContainer: document.getElementById('map'),
        totalDistance: document.getElementById('total-distance'),
        totalElevationGain: document.getElementById('total-elevation-gain'),
        totalElevationLoss: document.getElementById('total-elevation-loss'),
        averageGrade: document.getElementById('average-grade'),
        elevationChart: document.getElementById('elevation-chart'),
        weatherContainer: document.getElementById('weather-container'),
        segmentTable: document.getElementById('segment-table-body'),
        weatherTable: document.getElementById('weather-table-body'),
        trainingAdvice: document.getElementById('training-advice-content'),
        trainingAdviceContainer: document.getElementById('training-advice-container'),
        loadingAdvice: document.getElementById('loading-advice'),
        systemPrompt: document.getElementById('system-prompt'),
        userPrompt: document.getElementById('user-prompt'),
        resetSystemPrompt: document.getElementById('reset-system-prompt'),
        resetUserPrompt: document.getElementById('reset-user-prompt'),
        generateAdviceBtn: document.getElementById('generate-advice-btn')
    };
    
    let map = null;
    let chart = null;
    let hoverMarker = null;
    let allPoints = [];
    
    // 设置日期默认值为今天
    const today = new Date().toISOString().split('T')[0];
    elements.raceDate.value = today;
    
    // 检查表单是否可以提交
    function checkFormValidity() {
        const hasFile = elements.fileInput.files.length > 0;
        const hasDate = elements.raceDate.value.trim() !== '';
        elements.submitBtn.disabled = !(hasFile && hasDate);
    }
    
    // 显示文件名
    elements.fileInput.addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (file) {
            elements.fileName.textContent = file.name;
        } else {
            elements.fileName.textContent = '';
        }
        checkFormValidity();
    });
    
    // 监听日期变化
    elements.raceDate.addEventListener('change', checkFormValidity);
    
    // 处理表单提交
    elements.form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const file = elements.fileInput.files[0];
        const raceDate = elements.raceDate.value;
        const raceName = elements.raceName.value;
        
        if (!file || !raceDate) {
            alert('请选择GPX文件并填写比赛日期');
            return;
        }
        
        await handleFileUpload(file, raceDate, raceName);
    });
    
    // 处理文件上传
    async function handleFileUpload(file, raceDate, raceName) {
        try {
            elements.loadingDiv.style.display = 'block';
            document.getElementById('loading-text').textContent = '正在解析GPX文件...';
            elements.submitBtn.disabled = true;
            elements.uploadLabel.classList.add('disabled');
            elements.dataContainer.style.display = 'none';
            
            const formData = new FormData();
            formData.append('gpx_file', file);
            formData.append('race_date', raceDate);
            if (raceName) {
                formData.append('race_name', raceName);
            }
            
            const response = await fetch('/upload_gpx', {
                method: 'POST',
                body: formData
            });
            
            if (!response.ok) {
                throw new Error(`上传失败: ${response.status} ${response.statusText}`);
            }
            
            const data = await response.json();
            
            // 将数据ID保存到localStorage，以便页面刷新后仍能获取训练建议
            if (data.data_id) {
                localStorage.setItem('openrun_data_id', data.data_id);
                localStorage.setItem('openrun_match_date', raceDate);
            }
            
            // 更新加载状态文本
            document.getElementById('loading-text').textContent = '正在获取该地区历史天气信息...';
            
            await processGpxData(data);
            
            // 显示训练建议区域并获取默认提示词
            const adviceContainer = document.getElementById('training-advice-container');
            if (adviceContainer) {
                adviceContainer.style.display = 'block';
                // 获取默认提示词
                fetchDefaultPrompts();
            }
            
        } catch (error) {
            console.error('Error:', error);
            alert('上传文件时发生错误: ' + error.message);
        } finally {
            elements.loadingDiv.style.display = 'none';
            elements.submitBtn.disabled = false;
            elements.uploadLabel.classList.remove('disabled');
        }
    }
    
    // 延迟初始化地图，直到需要时才创建
    function initializeMap() {
        if (map) return map;
        
        map = L.map(elements.mapContainer, {
            zoomControl: true,
            attributionControl: true
        });
        
        L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap (CC-BY-SA)',
            maxZoom: 17
        }).addTo(map);
        
        L.control.zoom({
            position: 'topright'
        }).addTo(map);
        
        return map;
    }
    
    // 处理GPX数据
    async function processGpxData(data) {
        if (!data.points || data.points.length === 0) return;
        
        // 确保所有必需的容器都存在
        if (!elements.dataContainer || !elements.mapContainer || !elements.weatherContainer) {
            console.error('找不到必需的DOM元素');
            return;
        }
        
        elements.dataContainer.style.display = 'block';
        elements.mapContainer.style.display = 'block';
        elements.weatherContainer.style.display = 'block';
        
        const map = initializeMap();
        
        // 清除现有图层
        map.eachLayer((layer) => {
            if (!(layer instanceof L.TileLayer)) {
                map.removeLayer(layer);
            }
        });
        
        // 绘制路线
        allPoints = data.points;
        const polyline = L.polyline(allPoints, {
            color: 'red',
            weight: 2,
            smoothFactor: 1
        }).addTo(map);
        
        // 添加起点终点标记
        addMarkers(allPoints[0], allPoints[allPoints.length - 1]);
        
        // 调整地图视图
        map.fitBounds(polyline.getBounds(), {
            padding: [50, 50],
            maxZoom: 15
        });
        
        // 更新统计数据
        updateStats(data.stats);
        
        // 更新分段数据
        calculateSegmentData(data.elevation_data.distances, data.elevation_data.elevations);
        
        // 创建高程图表
        createElevationChart(data.elevation_data);
        
        // 获取天气数据
        const startPoint = data.points[0];
        fetchWeatherData(startPoint[0], startPoint[1], elements.raceDate.value);
    }
    
    // 添加起点和终点标记
    function addMarkers(startPoint, endPoint) {
        const createMarker = (point, color, text) => {
            return L.marker(point, {
                icon: L.divIcon({
                    className: 'custom-div-icon',
                    html: `<div style='background-color:${color};' class='marker-pin'></div><i class='fas fa-flag-checkered'></i>`,
                    iconSize: [30, 42],
                    iconAnchor: [15, 42]
                })
            }).addTo(map).bindPopup(text);
        };
        
        createMarker(startPoint, '#4CAF50', '起点');
        createMarker(endPoint, '#f44336', '终点');
    }
    
    // 更新统计数据
    function updateStats(stats) {
        elements.totalDistance.textContent = stats.distance.toFixed(2);
        elements.totalElevationGain.textContent = stats.elevation_gain.toFixed(0);
        elements.totalElevationLoss.textContent = stats.elevation_loss.toFixed(0);
        
        const averageGrade = (stats.elevation_gain / (stats.distance * 1000)) * 100;
        elements.averageGrade.textContent = averageGrade.toFixed(1) + '%';
    }
    
    // 创建高程图表
    function createElevationChart(elevationData) {
        if (chart) {
            chart.destroy();
        }
        
        const ctx = elements.elevationChart.getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: elevationData.distances,
                datasets: [{
                    label: '海拔（米）',
                    data: elevationData.elevations,
                    borderColor: '#FC4C02',
                    backgroundColor: 'rgba(252, 76, 2, 0.1)',
                    fill: true,
                    tension: 0.4,
                    pointRadius: 0,
                    pointHoverRadius: 4,
                    pointHoverBackgroundColor: '#FC4C02'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        callbacks: {
                            label: function(context) {
                                if (context.parsed.y !== null) {
                                    return `海拔（米）: ${context.parsed.y.toFixed(1)}`;
                                }
                            },
                            title: function(context) {
                                return `${context[0].parsed.x.toFixed(2)} km`;
                            }
                        }
                    }
                },
                hover: {
                    mode: 'index',
                    intersect: false
                },
                scales: {
                    x: {
                        type: 'linear',
                        min: 0,
                        max: elevationData.distances[elevationData.distances.length - 1],
                        title: {
                            display: true,
                            text: '距离（公里）'
                        },
                        ticks: {
                            maxRotation: 0,
                            callback: function(value) {
                                return Number.isInteger(value) ? value : null;
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '海拔（米）'
                        }
                    }
                },
                onHover: debounce((event, elements) => {
                    if (!elements || !elements.length) {
                        if (hoverMarker) {
                            map.removeLayer(hoverMarker);
                            hoverMarker = null;
                        }
                        return;
                    }
                    
                    const index = elements[0].index;
                    const point = allPoints[index];
                    
                    // 如果 marker 已经存在，只更新位置
                    if (hoverMarker) {
                        hoverMarker.setLatLng([point[0], point[1]]);
                    } else {
                        // 只在第一次创建 marker
                        hoverMarker = L.circleMarker([point[0], point[1]], {
                            radius: 8,
                            color: '#FC4C02',
                            fillColor: '#FC4C02',
                            fillOpacity: 0.7,
                            className: 'hover-marker'
                        }).addTo(map);
                    }
                }, 100)  // 增加防抖时间到 100ms
            }
        });
    }
    
    // 防抖函数
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }
    
    function calculateSegmentData(distances, elevations) {
        const tableBody = document.getElementById('segment-table-body');
        tableBody.innerHTML = '';
        
        let lastKm = 0;
        let lastElevation = elevations[0];
        let segmentGain = 0;
        let segmentLoss = 0;
        let segmentStartIndex = 0;
        let currentSegment = 1;
        
        for (let i = 1; i < distances.length; i++) {
            const currentKm = distances[i];
            const elevationDiff = elevations[i] - elevations[i-1];
            
            if (elevationDiff > 0) {
                segmentGain += elevationDiff;
            } else {
                segmentLoss += Math.abs(elevationDiff);
            }
            
            if (Math.floor(currentKm) > Math.floor(lastKm) || i === distances.length - 1) {
                const segmentDistance = distances[i] - distances[segmentStartIndex];
                const grade = (segmentGain / (segmentDistance * 1000)) * 100;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${currentSegment}</td>
                    <td>${currentKm.toFixed(2)}</td>
                    <td>${segmentGain.toFixed(0)}</td>
                    <td>${grade.toFixed(1)}</td>
                    <td>${segmentLoss.toFixed(0)}</td>
                `;
                tableBody.appendChild(row);
                
                segmentStartIndex = i;
                segmentGain = 0;
                segmentLoss = 0;
                currentSegment++;
            }
            
            lastKm = currentKm;
            lastElevation = elevations[i];
        }
    }
    
    // 获取天气数据
    async function fetchWeatherData(lat, lon, date) {
        try {
            elements.weatherContainer.querySelector('.weather-data').style.display = 'none';
            
            const response = await fetch('/get_weather_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lon,
                    date: date
                })
            });
            
            const result = await response.json();
            if (result.status === 'success') {
                displayWeatherData(result.data);
            } else {
                console.error('Error fetching weather data:', result.message);
            }
        } catch (error) {
            console.error('Error:', error);
        } finally {
            elements.weatherContainer.querySelector('.weather-data').style.display = 'block';
        }
    }
    
    // 显示天气数据
    function displayWeatherData(weatherData) {
        // 更新表格
        const tableBody = document.getElementById('weather-table-body');
        tableBody.innerHTML = '';
        
        if (!weatherData || weatherData.length === 0) {
            console.log('No weather data available');
            return;
        }
        
        weatherData.forEach(data => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${new Date(data.date).getFullYear()}</td>
                <td>${data.temperature?.toFixed(1)}°C</td>
                <td>${data.humidity?.toFixed(0)}%</td>
                <td>${data.precipitation?.toFixed(1)}mm</td>
                <td>${data.windspeed?.toFixed(1)}km/h</td>
            `;
            tableBody.appendChild(row);
        });
        
        // 检查是否存在canvas元素
        const canvas = document.getElementById('temperatureChart');
        if (!canvas) {
            console.warn('Temperature chart canvas element not found');
            return;
        }
        
        try {
            // 创建温度趋势图
            const ctx = canvas.getContext('2d');
            if (!ctx) {
                console.warn('Could not get 2D context from canvas');
                return;
            }
            
            // 安全地销毁现有图表
            if (window.temperatureChart && typeof window.temperatureChart.destroy === 'function') {
                window.temperatureChart.destroy();
            }
            
            // 手动设置canvas的高度
            canvas.style.height = '25px';
            canvas.height = 25;
            
            // 创建新的图表实例
            window.temperatureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: weatherData.map(data => new Date(data.date).getFullYear()),
                    datasets: [{
                        label: '温度 (°C)',
                        data: weatherData.map(data => data.temperature),
                        borderColor: '#FC4C02',
                        backgroundColor: 'rgba(252, 76, 2, 0.1)',
                        fill: true,
                        tension: 0.4,
                        borderWidth: 1.5,
                        pointRadius: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: false
                        },
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            title: {
                                display: true,
                                text: '温度 (°C)'
                            },
                            beginAtZero: false
                        }
                    },
                    layout: {
                        padding: {
                            top: 0,
                            right: 0,
                            bottom: 0,
                            left: 0
                        }
                    }
                }
            });
        } catch (error) {
            console.error('Error creating temperature chart:', error);
        }
    }

    // 获取训练建议（流式）
    function fetchTrainingAdvice() {
        const adviceContent = document.getElementById('training-advice-content');
        const loadingAdvice = document.getElementById('loading-advice');
        
        // 确保加载提示可见，隐藏之前的内容
        if (loadingAdvice) {
            loadingAdvice.style.display = 'flex';
        }
        
        // 清空现有内容
        if (adviceContent) {
            adviceContent.textContent = '';
        }
        
        // 从表单或localStorage获取比赛日期
        let matchDate = document.getElementById('race-date').value;
        if (!matchDate) {
            matchDate = localStorage.getItem('openrun_match_date');
        }
        
        if (!matchDate) {
            if (adviceContent) {
                adviceContent.textContent = '请选择比赛日期';
            }
            if (loadingAdvice) {
                loadingAdvice.style.display = 'none';
            }
            return;
        }

        // 获取存储的data_id
        const dataId = localStorage.getItem('openrun_data_id');
        
        // 获取自定义提示词
        const systemPrompt = elements.systemPrompt.value;
        const userPrompt = elements.userPrompt.value;
        
        // 记录调试信息
        console.log('准备获取训练建议:');
        console.log('- 比赛日期:', matchDate);
        console.log('- 数据ID:', dataId);
        console.log('- 系统提示词长度:', systemPrompt.length);
        console.log('- 用户提示词长度:', userPrompt.length);

        let hasReceivedData = false;

        // 创建URL，包含data_id参数和match_date参数
        let url = `/get_training_advice?match_date=${encodeURIComponent(matchDate)}`;
        if (dataId) {
            url += `&data_id=${encodeURIComponent(dataId)}`;
        }
        
        console.log('请求URL:', url);

        // 创建包含提示词的请求体
        const requestBody = {
            system_prompt: systemPrompt,
            user_prompt: userPrompt
        };

        // 创建EventSource对象发起请求
        const eventSource = new EventSource(url + '&custom_prompts=true');
        
        // 处理连接打开
        eventSource.onopen = function() {
            console.log('训练建议EventSource连接已打开');
            
            // 发送POST请求提交自定义提示词
            fetch('/submit_custom_prompts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            })
            .then(response => response.json())
            .then(data => {
                console.log('自定义提示词提交成功:', data);
            })
            .catch(error => {
                console.error('自定义提示词提交失败:', error);
                eventSource.close();
                if (adviceContent) {
                    adviceContent.innerHTML = `
                        <div style="color: red;">
                            <p>提交自定义提示词失败: ${error}</p>
                            <button onclick="fetchTrainingAdvice()">重新尝试</button>
                        </div>
                    `;
                }
                if (loadingAdvice) {
                    loadingAdvice.style.display = 'none';
                }
            });
        };
        
        // 处理消息 - 原样展示后台返回的内容
        eventSource.onmessage = function(event) {
            hasReceivedData = true;
            try {
                const data = JSON.parse(event.data);
                console.log('收到数据:', data);
                
                if (data.error) {
                    if (adviceContent) {
                        adviceContent.innerHTML = `
                            <div style="color: red;">
                                <p>获取训练建议出错: ${data.error}</p>
                                <p>可能原因:</p>
                                <ul>
                                    <li>GPX数据已过期或不存在</li>
                                    <li>服务器连接问题</li>
                                </ul>
                                <p>请尝试以下解决方案:</p>
                                <ul>
                                    <li>刷新页面并重新上传GPX文件</li>
                                    <li>检查网络连接</li>
                                </ul>
                                <button onclick="location.reload()">刷新页面</button>
                                <button onclick="fetchTrainingAdvice()">重新请求</button>
                            </div>
                        `;
                    }
                    eventSource.close();
                    if (loadingAdvice) {
                        loadingAdvice.style.display = 'none';
                    }
                    return;
                }
                
                if (data.text) {
                    // 检查是否是think标签内的内容，并添加特殊样式
                    if (adviceContent) {
                        // 如果首次接收到<think>标签，创建思考区域容器
                        if (data.text.includes('<think>') && !document.getElementById('ai-thinking-section')) {
                            const thinkingDiv = document.createElement('div');
                            thinkingDiv.id = 'ai-thinking-section';
                            thinkingDiv.className = 'ai-thinking-section';
                            thinkingDiv.innerHTML = '<details><summary>AI思考过程（点击展开/折叠）</summary><div class="thinking-content"></div></details>';
                            adviceContent.appendChild(thinkingDiv);
                        }

                        // 处理思考内容
                        if (document.getElementById('ai-thinking-section') && !data.text.includes('</think>')) {
                            const thinkingContent = document.querySelector('#ai-thinking-section .thinking-content');
                            if (thinkingContent) {
                                thinkingContent.textContent += data.text;
                            }
                        } 
                        // 如果收到结束标签，不添加到思考区域
                        else if (data.text.includes('</think>')) {
                            // 不处理结束标签
                        }
                        // 正常内容添加到主区域
                        else {
                            // 对于表格，进行特殊处理使其保持格式
                            let content = data.text;
                            
                            // 添加到主内容区域
                            if (content) {
                                if (adviceContent.lastChild && adviceContent.lastChild.nodeType === Node.TEXT_NODE) {
                                    adviceContent.lastChild.textContent += content;
                                } else {
                                    adviceContent.appendChild(document.createTextNode(content));
                                }
                            }
                        }
                        // 自动滚动到底部
                        adviceContent.scrollTop = adviceContent.scrollHeight;
                    }
                    
                    // 第一次接收到内容时，隐藏加载提示
                    if (loadingAdvice && loadingAdvice.style.display !== 'none') {
                        loadingAdvice.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('处理训练建议数据出错:', error);
                if (adviceContent) {
                    adviceContent.textContent += '\n处理数据出错，请刷新页面重试。';
                }
            }
        };
        
        // 处理错误
        eventSource.onerror = function(error) {
            console.error('EventSource错误:', error);
            
            if (eventSource.readyState === EventSource.CLOSED) {
                console.log('EventSource连接已关闭');
            } else {
                eventSource.close();
            }
            
            if (loadingAdvice) {
                loadingAdvice.style.display = 'none';
            }
            
            // 只有在没有收到过数据时才显示错误信息
            if (!hasReceivedData && adviceContent) {
                adviceContent.innerHTML = `
                    <div style="color: red;">
                        <p>获取训练建议失败，可能原因:</p>
                        <ul>
                            <li>GPX数据已过期或不存在（data_id: ${dataId || '未设置'}）</li>
                            <li>服务器连接问题</li>
                            <li>大模型API调用失败</li>
                        </ul>
                        <p>请尝试以下解决方案:</p>
                        <ul>
                            <li>刷新页面并重新上传GPX文件</li>
                            <li>检查网络连接</li>
                        </ul>
                        <button onclick="location.reload()">刷新页面</button>
                        <button onclick="fetchTrainingAdvice()">重新请求</button>
                    </div>
                `;
            }
        };
    }

    // 获取默认提示词
    async function fetchDefaultPrompts() {
        try {
            const response = await fetch('/get_default_prompts');
            const data = await response.json();
            
            if (data.status === 'success') {
                elements.systemPrompt.value = data.system_prompt;
                elements.userPrompt.value = data.user_prompt;
            } else {
                console.error('获取默认提示词失败:', data.message);
            }
        } catch (error) {
            console.error('获取默认提示词出错:', error);
        }
    }
    
    // 重置系统提示词按钮事件
    if (elements.resetSystemPrompt) {
        elements.resetSystemPrompt.addEventListener('click', async function() {
            try {
                const response = await fetch('/get_default_prompts');
                const data = await response.json();
                
                if (data.status === 'success') {
                    elements.systemPrompt.value = data.system_prompt;
                }
            } catch (error) {
                console.error('重置系统提示词出错:', error);
            }
        });
    }
    
    // 重置用户提示词按钮事件
    if (elements.resetUserPrompt) {
        elements.resetUserPrompt.addEventListener('click', async function() {
            try {
                const response = await fetch('/get_default_prompts');
                const data = await response.json();
                
                if (data.status === 'success') {
                    elements.userPrompt.value = data.user_prompt;
                }
            } catch (error) {
                console.error('重置用户提示词出错:', error);
            }
        });
    }
    
    // 生成训练建议按钮事件
    if (elements.generateAdviceBtn) {
        elements.generateAdviceBtn.addEventListener('click', function() {
            fetchTrainingAdvice();
        });
    }
});
</script>
{% endblock %} 